{% extends 'base.html' %}

{% block content %}

<div class="container mt-5">
    <h1 class="display-4 text-primary text-center">Nova Venda</h1>
    <hr class="border-primary border-2">

    <form action="/vendas/adicionar" method="POST">
        <div class="form-group">
            <label for="client_id">Cliente</label>
            <select id="client_id" name="client_id" class="form-control shadow-sm" required>
                <option value="">Selecione um cliente</option>
                {% for client in clients %}
                <option value="{{ client.id }}">{{ client.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="medicine_id">Medicamento</label>
            <select id="medicine_id" name="medicine_id" class="form-control shadow-sm" required>
                <option value="">Selecione um medicamento</option>
                {% for medicine in medicines %}
                <option value="{{ medicine.id }}" data-price="{{ medicine.price }}" data-stock="{{ medicine.quantity }}">
                    {{ medicine.name }} - R$ {{ "%.2f"|format(medicine.price) }} (Estoque: {{ medicine.quantity }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="quantity">Quantidade</label>
            <input type="number" id="quantity" name="quantity" class="form-control shadow-sm" min="1" required>
            <small class="text-muted">Estoque disponível: <span id="stock-info">0</span></small>
        </div>

        <div class="form-group mt-3">
            <label>Preço Total</label>
            <div class="input-group">
                <span class="input-group-text">R$</span>
                <input type="text" id="total_price" class="form-control" readonly>
            </div>
        </div>

        <div class="form-group mt-3 text-center">
            <button type="submit" class="btn btn-outline-primary btn-lg shadow-sm">Finalizar Venda</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const medicineSelect = document.getElementById('medicine_id');
    const quantityInput = document.getElementById('quantity');
    const stockInfo = document.getElementById('stock-info');
    const totalPriceInput = document.getElementById('total_price');

    function updateStockAndPrice() {
        const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
        if (selectedOption.value) {
            const price = parseFloat(selectedOption.dataset.price);
            const stock = parseInt(selectedOption.dataset.stock);
            stockInfo.textContent = stock;
            quantityInput.max = stock;
            
            const quantity = parseInt(quantityInput.value) || 0;
            totalPriceInput.value = (price * quantity).toFixed(2);
        } else {
            stockInfo.textContent = '0';
            totalPriceInput.value = '0.00';
        }
    }

    medicineSelect.addEventListener('change', updateStockAndPrice);
    quantityInput.addEventListener('input', updateStockAndPrice);
});
</script>

{% endblock %} 